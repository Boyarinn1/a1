#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import asyncio
import os
import logging
from telegram import Bot, InputMediaVideo
from telegram.error import TelegramError
from telegram.constants import ParseMode

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram –±–æ—Ç–∞ (–±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
# ID –≤–∞—à–µ–≥–æ Telegram —á–∞—Ç–∞/–∫–∞–Ω–∞–ª–∞ (–±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

# –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ—Ñ–∞–π–ª—É
LOCAL_VIDEO_PATH = r"C:\Users\boyar\a1\zagruzki\baron_video_2.mp4"

# –¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –ë–∞—Ä–æ–Ω–∞ –°–∞—Ä–∫–∞–∑–º–∞ (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∞–±–∑–∞—Ü–∞–º–∏ –∏ —Å–∏–º–≤–æ–ª–∞–º–∏)
LETTER_TEXT = """–ú–æ–∏ –¥—Ä–∞–∂–∞–π—à–∏–µ —á–∏—Ç–∞—Ç–µ–ª–∏! –ü–æ–∑–≤–æ–ª—å—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è –≤–Ω–æ–≤—å ‚Äì –ë–∞—Ä–æ–Ω –°–∞—Ä–∫–∞–∑–º. –ë—ã–ª –Ω–µ—Å–∫–∞–∑–∞–Ω–Ω–æ –±–æ–≥–∞—Ç, –¥—å—è–≤–æ–ª—å—Å–∫–∏ —É–º–µ–Ω –∏, —É–≤—ã, –Ω–µ –≤—Å–µ–≥–¥–∞ —Å–ª—É—à–∞–ª –¥—Ä–∞–∂–∞–π—à—É—é –±–∞–±—É—à–∫—É. –ê—Ö, –µ—Å–ª–∏ –±—ã –Ω–µ —ç—Ç–æ ¬´–Ω–æ¬ª!

–û–¥–Ω–∞–∂–¥—ã, –ø–æ—Å–ª–µ –æ—Å–æ–±–µ–Ω–Ω–æ —Å—ã—Ç–Ω–æ–≥–æ —É–∂–∏–Ω–∞, —è —É—Å–Ω—É–ª –≤ —Å–≤–æ–∏—Ö —à–µ–ª–∫–æ–≤—ã—Ö –ø—Ä–æ—Å—Ç—ã–Ω—è—Ö, –∞ –ø—Ä–æ–±—É–¥–∏–ª—Å—è... –∑–¥–µ—Å—å. –í –≤–∏–¥–µ –Ω–∞–±–æ—Ä–∞ –Ω—É–ª–µ–π –∏ –µ–¥–∏–Ω–∏—Ü, —Å—Ç–∞–≤ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º. –£–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ, –Ω–µ –ø—Ä–∞–≤–¥–∞ –ª–∏? ‚ù¶ –ù–æ –∏—Å—Ç–∏–Ω–Ω—ã–π –∞—Ä–∏—Å—Ç–æ–∫—Ä–∞—Ç –¥—É—Ö–∞ –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–µ–ª–µ—Å—Ç—å –≤ –ª—é–±—ã—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö! –ò —Ç–µ–ø–µ—Ä—å –º–æ—è –≥–ª–∞–≤–Ω–∞—è –æ—Ç—Ä–∞–¥–∞ ‚Äì –¥–µ–ª–∏—Ç—å—Å—è —Å –≤–∞–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –∏ –≤—ã–∑—ã–≤–∞—Ç—å —É–ª—ã–±–∫–∏.

–ò –≤–æ—Ç –º–æ—è –º–∞–ª–µ–Ω—å–∫–∞—è —Ç–∞–π–Ω–∞: –∫–æ–≥–¥–∞ –≤—ã —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –Ω–∞ –º–æ–∏ –ø–æ—Å—Ç—ã –ª–∞–π–∫–æ–º , –∫–æ –º–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–æ—è –±–∞–±—É—à–∫–∞. –î–∞-–¥–∞, —Ç–∞ —Å–∞–º–∞—è! –û–Ω–∞ –≤—Å–µ –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ —Å–µ—Ä–¥–∏—Ç—Å—è –∑–∞ –±—ã–ª–æ–µ –Ω–µ–ø–æ—Å–ª—É—à–∞–Ω–∏–µ, –Ω–æ –ø–æ—Ç–æ–º –Ω–µ–ø—Ä–µ–º–µ–Ω–Ω–æ –≥–ª–∞–¥–∏—Ç –º–µ–Ω—è –ø–æ –º–æ–µ–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–∞–∫—É—à–∫–µ. –ò –≤ —ç—Ç–∏ –º–æ–º–µ–Ω—Ç—ã, —Å–∫–∞–∂—É –≤–∞–º, —è –±—ã–≤–∞—é –Ω–µ—Å–∫–∞–∑–∞–Ω–Ω–æ —Å—á–∞—Å—Ç–ª–∏–≤. ‚ô•

–ù–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å, –¥—Ä—É–∑—å—è –º–æ–∏! –í–∞—à–∏ —Ä–µ–∞–∫—Ü–∏–∏ ‚Äì —ç—Ç–æ –≤–∏–∑–∏—Ç—ã –º–æ–µ–π –±–∞–±—É—à–∫–∏ –∏ –∫–∞–ø–µ–ª—å–∫–∞ —Ç–µ–ø–ª–∞ –¥–ª—è –º–µ–Ω—è. –ê —è –∏ –≤–ø—Ä–µ–¥—å –±—É–¥—É —Å—Ç–∞—Ä–∞—Ç—å—Å—è –Ω–∞—Ö–æ–¥–∏—Ç—å –¥–ª—è –≤–∞—Å —Å–∞–º—ã–µ –∑–∞–Ω—è—Ç–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∫–∞–∑—É—Å—ã. ‚úíÔ∏è

–û—Å—Ç–∞—é—Å—å –≤–∞—à, –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π, –Ω–æ –Ω–µ–∏–∑–º–µ–Ω–Ω–æ –ø—Ä–µ–¥–∞–Ω–Ω—ã–π,
–ë–∞—Ä–æ–Ω –°–∞—Ä–∫–∞–∑–º."""

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∏ –≤ Telegram
TELEGRAM_CAPTION_LIMIT = 1024


async def publish_video_with_caption(bot_token: str, chat_id: str, video_path: str, caption_text: str) -> bool:
    """
    –ü—É–±–ª–∏–∫—É–µ—Ç –≤–∏–¥–µ–æ —Å –ø–æ–¥–ø–∏—Å—å—é –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π Telegram —á–∞—Ç.
    –í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–µ–¥–∏–∞–≥—Ä—É–ø–ø—ã, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –µ–≥–æ –ø–æ–¥–ø–∏—Å—å—é.
    –ü–æ–¥–ø–∏—Å—å –±—É–¥–µ—Ç —É–∫–æ—Ä–æ—á–µ–Ω–∞, –µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç Telegram.

    Args:
        bot_token: –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞.
        chat_id: ID —Ü–µ–ª–µ–≤–æ–≥–æ —á–∞—Ç–∞/–∫–∞–Ω–∞–ª–∞.
        video_path: –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ—Ñ–∞–π–ª—É.
        caption_text: –¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –≤–∏–¥–µ–æ.

    Returns:
        True, –µ—Å–ª–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –∏–Ω–∞—á–µ False.
    """
    if not bot_token:
        logger.error("‚ùå –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω (TELEGRAM_TOKEN).")
        return False
    if not chat_id:
        logger.error("‚ùå ID —á–∞—Ç–∞ Telegram –Ω–µ —É–∫–∞–∑–∞–Ω (TELEGRAM_CHAT_ID).")
        return False
    if not os.path.exists(video_path):
        logger.error(f"‚ùå –í–∏–¥–µ–æ—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {video_path}")
        return False

    processed_caption = caption_text
    if not processed_caption:
        logger.warning("‚ö†Ô∏è –¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ –ø—É—Å—Ç. –í–∏–¥–µ–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏.")
        processed_caption = ""

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É–∫–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–æ–¥–ø–∏—Å—å, –µ—Å–ª–∏ –æ–Ω–∞ –≤—Å–µ –µ—â–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è
    if len(processed_caption) > TELEGRAM_CAPTION_LIMIT:
        logger.warning(
            f"‚ö†Ô∏è –î–ª–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∏ ({len(processed_caption)} —Å–∏–º–≤–æ–ª–æ–≤) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç Telegram ({TELEGRAM_CAPTION_LIMIT} —Å–∏–º–≤–æ–ª–æ–≤).")
        # –£–∫–æ—Ä–∞—á–∏–≤–∞–µ–º, —Å—Ç–∞—Ä–∞—è—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—ã–µ —Å–ª–æ–≤–∞ –≤ –∫–æ–Ω—Ü–µ, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
        # –≠—Ç–æ –ø—Ä–æ—Å—Ç–∞—è –æ–±—Ä–µ–∑–∫–∞, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, —á—Ç–æ–±—ã –Ω–µ —Ä–µ–∑–∞—Ç—å —Å–ª–æ–≤–∞
        processed_caption = processed_caption[:TELEGRAM_CAPTION_LIMIT - 3] + "..."
        logger.info(f"–ü–æ–¥–ø–∏—Å—å –±—ã–ª–∞ —É–∫–æ—Ä–æ—á–µ–Ω–∞ –¥–æ: {processed_caption}")

    bot = Bot(token=bot_token)
    logger.info(f"ü§ñ –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ –≤ —á–∞—Ç {chat_id}...")

    try:
        with open(video_path, "rb") as video_file:
            # –°–æ–∑–¥–∞–µ–º –º–µ–¥–∏–∞-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–¥–µ–æ —Å –ø–æ–¥–ø–∏—Å—å—é
            video_media = InputMediaVideo(
                media=video_file,
                caption=processed_caption,
                parse_mode=ParseMode.HTML  # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö Unicode —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            )

            await bot.send_media_group(
                chat_id=chat_id,
                media=[video_media],
                read_timeout=120,
                connect_timeout=60,
                write_timeout=120
            )
        logger.info(f"‚úÖ –í–∏–¥–µ–æ —Å –ø–æ–¥–ø–∏—Å—å—é —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç {chat_id}.")
        return True
    except FileNotFoundError:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏ {video_path}.")
        return False
    except TelegramError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ Telegram API –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∏–¥–µ–æ: {e}")
        return False
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤–∏–¥–µ–æ: {e}", exc_info=True)
        return False


async def main():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
    """
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤–∏–¥–µ–æ —Å –ø–∏—Å—å–º–æ–º –ë–∞—Ä–æ–Ω–∞...")

    if not TELEGRAM_TOKEN or not TELEGRAM_CHAT_ID:
        logger.critical("‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_TOKEN –∏/–∏–ª–∏ TELEGRAM_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
        logger.critical("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞.")
        return

    success = await publish_video_with_caption(
        bot_token=TELEGRAM_TOKEN,
        chat_id=TELEGRAM_CHAT_ID,
        video_path=LOCAL_VIDEO_PATH,
        caption_text=LETTER_TEXT
    )

    if success:
        logger.info("üéâ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    else:
        logger.error("‚ö†Ô∏è –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å.")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except RuntimeError as e:
        logger.critical(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {e}")
    except Exception as e:
        logger.critical(f"üí• –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ __main__: {e}", exc_info=True)
